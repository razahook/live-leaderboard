<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Stream Viewer - Apex Legends Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gutter {
            background-color: #374151;
            background-repeat: no-repeat;
            background-position: 50%;
            cursor: col-resize;
        }
        .gutter.gutter-horizontal {
            cursor: col-resize;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+YMK0myAUEYBAAAAP//AwB1VCwsAAAAAElFTkSuQmCC');
        }
        .stream-container {
            min-height: 400px;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="text-orange-500 hover:text-orange-400 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Leaderboard
                </a>
                <h1 class="text-2xl font-bold text-white">Multi-Stream Viewer</h1>
            </div>
            <div class="text-sm text-gray-400">
                Watch multiple Apex streamers simultaneously
            </div>
        </div>
    </div>

    <!-- Stream Selection Controls -->
    <div class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700/50 px-6 py-4">
        <div class="max-w-6xl mx-auto">
            <!-- Streamer Selection -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Streamer 1 -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-300">Stream 1</label>
                    <select id="streamer1" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="">Select Streamer 1</option>
                    </select>
                </div>
                
                <!-- Streamer 2 -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-300">Stream 2</label>
                    <select id="streamer2" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="">Select Streamer 2</option>
                    </select>
                </div>
                
                <!-- Streamer 3 -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-300">Stream 3</label>
                    <select id="streamer3" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="">Select Streamer 3</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="loadStreams()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                    <i class="fas fa-play mr-2"></i>Load Streams
                </button>
                <button onclick="clearStreams()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>Clear All
                </button>
                <button onclick="toggleLayoutPresets()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                    <i class="fas fa-th mr-2"></i>Layout Options
                </button>
            </div>

            <!-- Layout Presets (Hidden by default) -->
            <div id="layoutPresets" class="hidden mt-4 p-4 bg-gray-700/50 rounded-lg">
                <div class="flex gap-2 flex-wrap">
                    <button onclick="setLayout('equal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded transition-colors text-sm">
                        Equal Split
                    </button>
                    <button onclick="setLayout('main-left')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded transition-colors text-sm">
                        Main Left
                    </button>
                    <button onclick="setLayout('main-center')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded transition-colors text-sm">
                        Main Center
                    </button>
                    <button onclick="setLayout('vertical')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded transition-colors text-sm">
                        Vertical Stack
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stream Container -->
    <div class="flex-1 p-6">
        <div id="streamContainer" class="stream-container min-h-[500px] bg-gray-800/30 rounded-lg border border-gray-700/50">
            <div class="flex items-center justify-center h-full text-gray-400">
                <div class="text-center">
                    <i class="fas fa-tv text-4xl mb-4"></i>
                    <p class="text-lg mb-2">Select streamers above to start watching</p>
                    <p class="text-sm">Choose up to 3 streamers and click "Load Streams"</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allPlayers = [];
        let splitInstance = null;
        const API_BASE_URL = window.location.origin;

        // Load player data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Stream] Loading player data...');
            await loadPlayerData();
            populateDropdowns();
            
            // Auto-load from URL params if provided
            const urlParams = new URLSearchParams(window.location.search);
            const s1 = urlParams.get('s1');
            const s2 = urlParams.get('s2');
            const s3 = urlParams.get('s3');
            
            if (s1 || s2 || s3) {
                if (s1) document.getElementById('streamer1').value = s1;
                if (s2) document.getElementById('streamer2').value = s2;
                if (s3) document.getElementById('streamer3').value = s3;
                setTimeout(loadStreams, 500);
            }
        });

        // Load player data from API
        async function loadPlayerData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/leaderboard/PC`);
                const data = await response.json();
                
                if (data?.success && data?.data) {
                    // Normalize to an array of players
                    const players = Array.isArray(data.data)
                        ? data.data
                        : (Array.isArray(data.data.players) ? data.data.players : []);
                    allPlayers = players;
                    console.log('[Stream] Loaded players:', allPlayers.length);
                } else {
                    console.error('[Stream] API returned error:', data);
                    allPlayers = [];
                }
            } catch (error) {
                console.error('[Stream] Error loading player data:', error);
                allPlayers = [];
            }
        }

        // Populate streamer dropdowns
        function populateDropdowns() {
            console.log('[Stream] Populating dropdowns...');
            console.log('[Stream] Total players:', Array.isArray(allPlayers) ? allPlayers.length : 0);
            
            // Filter for live streamers using same logic as main page
            const liveStreamers = (Array.isArray(allPlayers) ? allPlayers : []).filter(player => {
                const twitchLive = player.twitch_live?.is_live === true;
                const hasStreamData = player.stream !== null && player.stream !== undefined || player.twitch_live?.stream_data;
                const twitchUser = resolveTwitchUser(player);
                const statusLive = String(player.status || '').toLowerCase().includes('live');
                return (twitchLive || statusLive) && hasStreamData && !!twitchUser;
            });

            console.log('[Stream] Live streamers found:', liveStreamers.length);
            
            if (liveStreamers.length === 0) {
                console.warn('[Stream] No live streamers found! Sample data:');
                console.log('[Stream] First 3 players:', allPlayers.slice(0, 3).map(p => ({
                    name: p.name || p.player_name,
                    status: p.status,
                    twitch_live: p.twitch_live,
                    stream: p.stream
                })));
            }

            const dropdowns = ['streamer1', 'streamer2', 'streamer3'];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                const placeholder = dropdown.options[0];
                dropdown.innerHTML = '';
                dropdown.appendChild(placeholder);

                liveStreamers.forEach(player => {
                    const twitchUser = resolveTwitchUser(player);
                    const option = document.createElement('option');
                    option.value = twitchUser;
                    const viewers = player.stream?.viewers || player.twitch_live?.stream_data?.viewer_count || 0;
                    option.textContent = `${player.name || player.player_name || twitchUser} (${viewers} viewers)`;
                    option.dataset.playerName = player.name || player.player_name;
                    dropdown.appendChild(option);
                });
            });

            // Add change listeners
            dropdowns.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateURLParams);
                }
            });
        }

        // Update URL parameters when selections change
        function updateURLParams() {
            const s1 = document.getElementById('streamer1').value;
            const s2 = document.getElementById('streamer2').value;
            const s3 = document.getElementById('streamer3').value;
            
            const params = new URLSearchParams();
            if (s1) params.set('s1', s1);
            if (s2) params.set('s2', s2);
            if (s3) params.set('s3', s3);
            
            const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            window.history.replaceState({}, '', newURL);
        }

        // Load selected streams
        function loadStreams() {
            const s1 = document.getElementById('streamer1').value;
            const s2 = document.getElementById('streamer2').value;
            const s3 = document.getElementById('streamer3').value;
            
            const streamers = [s1, s2, s3].filter(s => s && s.trim());
            
            console.log('[Stream] Loading streamers:', streamers);
            
            if (streamers.length === 0) {
                alert('Please select at least one streamer');
                return;
            }

            const container = document.getElementById('streamContainer');
            container.innerHTML = '';

            // Destroy existing split instance
            if (splitInstance) {
                splitInstance.destroy();
                splitInstance = null;
            }

            // Create stream panels
            const panelHTML = streamers.map((streamer, index) => {
                return `
                    <div id="stream-panel-${index}" class="stream-panel bg-gray-800 rounded-lg overflow-hidden" style="min-height: 400px;">
                        <div class="bg-gray-700 px-4 py-2 border-b border-gray-600">
                            <h3 class="font-semibold text-white">${getStreamerDisplayName(streamer)}</h3>
                        </div>
                        <div class="relative w-full" style="aspect-ratio: 16/9;">
                            <div id="loading-${index}" class="absolute inset-0 flex items-center justify-center bg-gray-800">
                                <div class="text-center">
                                    <div class="loading-spinner w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                                    <p class="text-gray-300">Loading ${streamer}...</p>
                                </div>
                            </div>
                            <div id="stream-${index}" class="absolute inset-0"></div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="flex gap-4 h-full">${panelHTML}</div>`;

            // Load each stream
            streamers.forEach((streamer, index) => {
                setTimeout(() => loadTwitchEmbed(index, streamer), index * 500);
            });

            // Initialize Split.js for resizable panels if more than 1 stream
            if (streamers.length > 1) {
                setTimeout(() => {
                    const panelIds = streamers.map((_, i) => `#stream-panel-${i}`);
                    const sizes = streamers.map(() => 100 / streamers.length);
                    
                    try {
                        splitInstance = Split(panelIds, {
                            sizes: sizes,
                            minSize: 200,
                            gutterSize: 8,
                            direction: 'horizontal'
                        });
                    } catch (e) {
                        console.warn('[Stream] Split.js init failed:', e);
                    }
                }, 100);
            }
        }

        // Load individual Twitch embed
        function loadTwitchEmbed(index, streamer) {
            console.log(`[Stream] Loading embed ${index}: ${streamer}`);
            
            try {
                if (typeof Twitch === 'undefined' || !Twitch.Embed) {
                    throw new Error('Twitch embed script not loaded');
                }

                const hostname = window.location.hostname;
                
                new Twitch.Embed(`stream-${index}`, {
                    width: "100%",
                    height: "100%",
                    channel: streamer,
                    layout: "video",
                    muted: true,
                    autoplay: true,
                    parent: [hostname]
                });

                // Hide loading indicator
                setTimeout(() => {
                    const loading = document.getElementById(`loading-${index}`);
                    if (loading) loading.style.display = 'none';
                }, 1000);

            } catch (error) {
                console.error(`[Stream] Error loading ${streamer}:`, error);
                
                // Show error in stream container
                const streamDiv = document.getElementById(`stream-${index}`);
                if (streamDiv) {
                    streamDiv.innerHTML = `
                        <div class="flex items-center justify-center h-full bg-gray-900 text-center p-4">
                            <div>
                                <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
                                <p class="text-red-400 font-semibold mb-2">Failed to load stream</p>
                                <p class="text-gray-400 text-sm mb-3">${error.message}</p>
                                <a href="https://twitch.tv/${streamer}" target="_blank" class="inline-block bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                                    Watch on Twitch
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                const loading = document.getElementById(`loading-${index}`);
                if (loading) loading.style.display = 'none';
            }
        }

        // Resolve twitch username from various shapes
        function resolveTwitchUser(player) {
            if (!player) return '';
            if (player.stream?.twitchUser) return String(player.stream.twitchUser).toLowerCase();
            if (player.twitch_live?.user_data?.login) return String(player.twitch_live.user_data.login).toLowerCase();
            if (player.twitch_link) {
                try {
                    const m = String(player.twitch_link).match(/twitch\.tv\/(\w+)/i);
                    if (m && m[1]) return m[1].toLowerCase();
                } catch {}
            }
            return '';
        }

        // Get display name for streamer
        function getStreamerDisplayName(twitchUser) {
            const player = allPlayers.find(p => p.stream?.twitchUser === twitchUser);
            return player ? (player.name || player.player_name) : twitchUser;
        }

        // Clear all streams
        function clearStreams() {
            document.getElementById('streamer1').value = '';
            document.getElementById('streamer2').value = '';
            document.getElementById('streamer3').value = '';
            
            const container = document.getElementById('streamContainer');
            container.innerHTML = `
                <div class="flex items-center justify-center h-full text-gray-400">
                    <div class="text-center">
                        <i class="fas fa-tv text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Select streamers above to start watching</p>
                        <p class="text-sm">Choose up to 3 streamers and click "Load Streams"</p>
                    </div>
                </div>
            `;

            if (splitInstance) {
                splitInstance.destroy();
                splitInstance = null;
            }
            
            updateURLParams();
        }

        // Toggle layout presets visibility
        function toggleLayoutPresets() {
            const presets = document.getElementById('layoutPresets');
            presets.classList.toggle('hidden');
        }

        // Set layout preset
        function setLayout(layout) {
            if (!splitInstance) return;

            const panels = splitInstance.getSizes().length;
            let sizes;

            switch (layout) {
                case 'equal':
                    sizes = Array(panels).fill(100 / panels);
                    break;
                case 'main-left':
                    sizes = panels === 2 ? [70, 30] : [60, 20, 20];
                    break;
                case 'main-center':
                    sizes = panels === 3 ? [25, 50, 25] : [30, 70];
                    break;
                case 'vertical':
                    // This would require changing to vertical split
                    sizes = Array(panels).fill(100 / panels);
                    break;
                default:
                    sizes = Array(panels).fill(100 / panels);
            }

            splitInstance.setSizes(sizes);
        }
    </script>
</body>
</html>