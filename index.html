<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Chosen Palette: Deep Dark (Black/Dark Gray), Muted Grays, with Emerald Green, Indigo, and Red Accents) -->
    <!-- Application Structure Plan: A top-down dashboard structure was chosen for optimal information hierarchy, now enhanced with top-level tabbed navigation. The 'Leaderboard' tab provides an immediate snapshot of high-level key metrics (Predator Thresholds) and an interactive data table for detailed exploration (Leaderboard), equipped with search, filter, pagination, data visualizations, and Twitch override. A new 'Player Stats & Match History' tab offers a dedicated interface for individual player lookups, allowing users to query by name/UID and platform. This tab will display detailed player statistics. This tabbed approach provides clear functional separation, improving user understanding and ease of navigation by allowing users to switch contexts easily without leaving the single page. -->
    <!-- Visualization & Content Choices: 
        - Predator Thresholds -> Goal: Inform -> Presentation: 4-Card Layout -> Interaction: None -> Justification: Key metrics are best presented as prominent, easily scannable cards at the top.
        - Leaderboard Data -> Goal: Organize/Compare/Explore -> Presentation: Interactive HTML Table with Pagination -> Interaction: Search, Live-Only Toggle, Hover for Twitch Preview, Click for AI Analysis, Pagination Controls (Next/Previous/Page Numbers) -> Justification: A table is essential for displaying detailed, multi-column data. The interactions allow users to drill down and find specific information efficiently, and pagination prevents overwhelming the user with too much data at once.
        - Top 20 Player RP -> Goal: Compare -> Presentation: Bar Chart (Chart.js) -> Interaction: Hover for Tooltip -> Justification: A bar chart provides a much faster and more intuitive way to compare the RP of top players than scanning a table column.
        - Masters & Predators by Platform -> Goal: Compare/Inform -> Presentation: Doughnut Chart (Chart.js) -> Interaction: Hover for Tooltip -> Justification: A doughnut chart is excellent for showing the proportional distribution of the player base across different platforms, offering a high-level summary.
        - Twitch Override Management -> Goal: Manage Data -> Presentation: Input Form within Modal -> Interaction: Text Input, Submit Button -> Justification: Provides direct user control over specific data points (Twitch links), making the application more dynamic and responsive to user needs.
        - Player Stats & Match History -> Goal: Inform/Explore (Individual) -> Presentation: Input Form, Dynamic Text/Stat Display with Legend Tips and Match History, API Selection -> Interaction: Text Input, Select Dropdown, Submit Button, Click for Legend Tips, Radio Buttons for API Selection -> Justification: Allows granular lookup of specific player data from multiple sources, complementing the aggregate leaderboard view, and provides AI-generated lore and tips for selected legends, and detailed match history.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Apex Legends Leaderboard SPA</title>
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0c0a09; /* Deep dark background */
            color: #e5e7eb; /* Light gray text */
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .toggle-checkbox:checked { transform: translateX(100%); border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        @keyframes pulse-live { 
            0%, 100% { transform: scale(1); box-shadow: 0 0 3px #ef4444, 0 0 5px #ef4444; } 
            50% { transform: scale(1.05); box-shadow: 0 0 10px #ef4444, 0 0 15px #ef4444; } 
        }
        .animate-live-pulse { animation: pulse-live 2.5s infinite ease-in-out; }
        #stream-preview { 
            position: fixed; z-index: 50; width: 320px; height: 180px; 
            border: 1px solid #4b5563; border-radius: 0.5rem; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); 
            overflow: hidden; pointer-events: none; 
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; 
            opacity: 0; transform: scale(0.95); 
        }
        .modal {
            position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #1f2937; /* Darker gray for modal content */
            margin: auto; padding: 24px;
            border-radius: 0.75rem; border: 1px solid #4b5563;
            width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transform: translateY(-20px); transition: transform 0.3s ease;
        }
        .modal.show .modal-content { transform: translateY(0); }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: white; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #3b82f6;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        /* Tab styles */
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #1f2937;
            color: #9ca3af;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            background-color: #0c0a09;
            color: #ffffff;
            border-bottom-color: #4f46e5; /* Indigo-600 */
        }
        .tab-content {
            display: none;
            padding-top: 1rem;
            border-top: 3px solid #1f2937;
        }
        .tab-content.active {
            display: block;
        }
        /* New styles for nicer UI */
        .stat-card {
            background-color: #1f2937; /* bg-gray-800 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #374151; /* border-gray-700 */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .legend-card {
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            min-height: 250px;
        }
        .legend-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to top, rgba(31, 41, 55, 1) 10%, rgba(31, 41, 55, 0.7) 50%, rgba(31, 41, 55, 0.4) 100%);
            z-index: 1;
        }
        .legend-card > * {
            position: relative;
            z-index: 2;
        }
        .match-card {
            background-color: #273344;
            border-left: 4px solid #4f46e5; /* Indigo */
            padding: 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .match-card:hover {
            background-color: #374151;
        }
        .api-source-label {
            padding: 0.5rem 1rem;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .api-source-radio:checked + .api-source-label {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        .api-source-radio {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white">Apex Legends Ranked Dashboard</h1>
            <p class="text-gray-300 mt-2">Live insights into the Predator leaderboards and platform statistics.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-700/50 mb-6">
            <button class="tab-button active" onclick="showTab('leaderboardTab')">Leaderboard</button>
            <button class="tab-button" onclick="showTab('playerStatsTab')">Player Stats & Match History</button>
        </div>

        <!-- Leaderboard Tab Content -->
        <div id="leaderboardTab" class="tab-content active">
            <section id="key-metrics" class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-4">Predator Thresholds</h2>
                <div id="predator-thresholds" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg text-center text-gray-500 border border-gray-700/50">Loading PC...</div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center text-gray-500 border border-gray-700/50">Loading PlayStation...</div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center text-gray-500 border border-gray-700/50">Loading Xbox...</div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center text-gray-500 border border-gray-700/50">Loading Switch...</div>
                </div>
            </section>

            <section id="interactive-leaderboard" class="mb-10">
                <div class="mb-6 pb-4 border-b border-gray-700/50">
                    <h2 class="text-2xl font-bold text-white">Live Ranked Leaderboard</h2>
                </div>

                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
                    <div class="relative w-full sm:w-auto sm:flex-grow max-w-xs">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="none"><path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>
                        <input type="text" id="searchInput" placeholder="Search players..." class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-medium text-white">Live Streamers Only</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none">
                            <input type="checkbox" name="toggle" id="liveOnlyToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-gray-600 appearance-none cursor-pointer transition-transform duration-200 ease-in"/>
                            <label for="liveOnlyToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-lg shadow-2xl shadow-black/30">
                    <table class="w-full min-w-max text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700/20">
                            <tr>
                                <th scope="col" class="px-6 py-3">Rank</th><th scope="col" class="px-6 py-3">Player</th><th scope="col" class="px-6 py-3">RP</th>
                                <th scope="col" class="px-6 py-3">24h Change</th><th scope="col" class="px-6 py-3">Level</th><th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3">Stream</th>
                                <th scope="col" class="px-6 py-3">AI Analysis</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="divide-y divide-gray-700/50"><tr><td colspan="8" class="text-center py-10 text-gray-400">Loading players...</td></tr></tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div id="pagination-controls" class="flex justify-center items-center space-x-2 mt-4 text-gray-300">
                    <button id="prevPage" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <div id="pageNumbers" class="flex space-x-1"></div>
                    <button id="nextPage" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
            </section>

            <section id="data-visualizations" class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Data Visualizations</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-lg shadow-2xl shadow-black/30 border border-gray-700/50">
                        <h3 class="text-lg font-semibold text-gray-300 mb-4 text-center">Top 20 Players by RP</h3>
                        <div class="chart-container">
                            <canvas id="rpDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-lg shadow-2xl shadow-black/30 border border-gray-700/50">
                        <h3 class="text-lg font-semibold text-gray-300 mb-4 text-center">Masters & Predators by Platform</h3>
                        <div class="chart-container" style="max-width: 450px; height: 400px;">
                            <canvas id="platformDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="twitch-override-management" class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-4">Twitch Override Management</h2>
                <p class="text-gray-300 mb-6">Manually link an in-game player name to a Twitch channel or override an existing link. This is useful for players whose Twitch streams aren't automatically detected.</p>
                <button onclick="showOverrideModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 shadow-md">Add/Update Twitch Override</button>
            </section>
        </div>

        <!-- Player Stats & Match History Tab Content -->
        <div id="playerStatsTab" class="tab-content">
            <section class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-4">Player Statistics Lookup</h2>
                <p class="text-gray-300 mb-6">Enter a player's name or UID and platform to retrieve their current statistics. Using UID is recommended for consistent lookups.</p>
                
                <form id="playerStatsForm" class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-lg shadow-2xl shadow-black/30 border border-gray-700/50 space-y-4">
                    <!-- API Selection -->
                    <div class="mb-4">
                        <label class="block text-gray-300 text-sm font-bold mb-2">Choose API Source:</label>
                        <div class="flex items-center space-x-4">
                             <label>
                                <input type="radio" name="apiSource" value="tracker" class="api-source-radio" checked onchange="handleApiSourceChange()">
                                <span class="api-source-label">Tracker.gg</span>
                            </label>
                            <label>
                                <input type="radio" name="apiSource" value="mozambique" class="api-source-radio" onchange="handleApiSourceChange()">
                                <span class="api-source-label">MozambiqueHe.re</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="playerIdentifier" class="block text-gray-300 text-sm font-bold mb-2">Player Name or UID:</label>
                        <input type="text" id="playerIdentifier" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-900 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-500" placeholder="e.g., Shroud or 1234567890" required>
                    </div>
                    <div>
                        <label for="platformSelect" class="block text-gray-300 text-sm font-bold mb-2">Platform:</label>
                        <select id="platformSelect" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-900 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-500" required>
                            <option value="origin" data-mozambique-platform="PC">PC (Origin/Steam)</option>
                            <option value="psn" data-mozambique-platform="PS4">PlayStation (PS4/PS5)</option>
                            <option value="xbl" data-mozambique-platform="X1">Xbox</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center text-gray-300 text-sm">
                            <input type="checkbox" id="useUidCheckbox" class="mr-2 leading-tight" disabled>
                            Use UID instead of Name (MozambiqueHe.re only)
                        </label>
                    </div>
                    <div id="playerStatsMessage" class="text-sm font-medium"></div>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">Get Player Stats</button>
                </form>

                <div id="playerStatsResult" class="mt-8">
                    <div id="playerStatsContent" class="text-gray-300">
                        <p>Enter player details and click "Get Player Stats" to see results.</p>
                    </div>
                </div>
                
                <div id="matchHistoryResult" class="mt-8" style="display: none;">
                     <h3 class="text-xl font-bold text-white mb-4">Match History</h3>
                    <div id="matchHistoryContent" class="text-gray-300">
                        <p>Match history will appear here.</p>
                    </div>
                </div>
            </section>
        </div>

    </div>

    <div id="stream-preview"><div id="stream-preview-player"></div></div>

    <!-- AI Analysis Modal -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="hideModal()">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold text-white mb-4">Player Performance Analysis</h2>
            <div id="modalContent" class="text-gray-300">
                <div class="spinner"></div>
                <p class="text-center mt-2">Generating analysis...</p>
            </div>
        </div>
    </div>

    <!-- Twitch Override Modal -->
    <div id="overrideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="hideOverrideModal()">&times;</span>
            <h2 class="text-xl font-bold text-white mb-4">Manage Twitch Override</h2>
            <form id="overrideForm" class="space-y-4">
                <div>
                    <label for="overridePlayerName" class="block text-gray-300 text-sm font-bold mb-2">Player Name (in-game):</label>
                    <input type="text" id="overridePlayerName" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-800 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500" placeholder="e.g., Shroud" required>
                </div>
                <div>
                    <label for="overrideTwitchUsername" class="block text-gray-300 text-sm font-bold mb-2">Twitch Username:</label>
                    <input type="text" id="overrideTwitchUsername" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-800 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500" placeholder="e.g., shroud" required>
                </div>
                <div id="overrideMessage" class="text-sm font-medium"></div>
                <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">Submit Override</button>
            </form>
        </div>
    </div>

    <script>
        let allPlayers = [];
        let filteredAndSortedPlayers = []; 
        let currentPage = 1;
        const itemsPerPage = 50; 
        let previewTimeout;
        // DELETED: const NGROK_BASE_URL = '...'; 
        const MOZAMBIQUE_API_KEY = '456c01cf240c13399563026f5604d777'; 
        const TRACKER_GG_API_KEY = 'c4cc3d18-adaf-487b-b3da-d47b924585c4'; 
        const GEMINI_API_KEY = "AIzaSyA_sdFUk6nrcC8sK3ZlnFbEexJgCTd8SqU";
        
        // API base URL - use Flask server for development, relative URLs for production
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000' : '';
        
        const leaderboardBody = document.getElementById('leaderboard-body');
        const searchInput = document.getElementById('searchInput');
        const liveOnlyToggle = document.getElementById('liveOnlyToggle');
        const streamPreview = document.getElementById('stream-preview');
        const streamPreviewPlayer = document.getElementById('stream-preview-player');
        const predatorThresholdsDiv = document.getElementById('predator-thresholds'); 
        const analysisModal = document.getElementById('analysisModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');

        const overrideModal = document.getElementById('overrideModal');
        const overrideForm = document.getElementById('overrideForm');
        const overridePlayerNameInput = document.getElementById('overridePlayerName');
        const overrideTwitchUsernameInput = document.getElementById('overrideTwitchUsername');
        const overrideMessageDiv = document.getElementById('overrideMessage');

        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageNumbersDiv = document.getElementById('pageNumbers');

        const playerStatsForm = document.getElementById('playerStatsForm');
        const playerIdentifierInput = document.getElementById('playerIdentifier');
        const platformSelect = document.getElementById('platformSelect');
        const useUidCheckbox = document.getElementById('useUidCheckbox'); 
        const playerStatsMessageDiv = document.getElementById('playerStatsMessage');
        const playerStatsResultDiv = document.getElementById('playerStatsResult');
        const playerStatsContentDiv = document.getElementById('playerStatsContent');
        const matchHistoryResultDiv = document.getElementById('matchHistoryResult'); 
        const matchHistoryContentDiv = document.getElementById('matchHistoryContent'); 

        let rpChart = null;
        let platformChart = null;

        const showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
        };

        const showModal = (title, contentHtml) => {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHtml;
            analysisModal.classList.add('show');
        };

        const hideModal = () => {
            analysisModal.classList.remove('show');
            modalContent.innerHTML = '<div class="spinner"></div><p class="text-center mt-2">Generating analysis...</p>';
        };

        const showOverrideModal = () => {
            overrideModal.classList.add('show');
            overrideMessageDiv.textContent = ''; 
            overridePlayerNameInput.value = ''; 
            overrideTwitchUsernameInput.value = '';
        };

        const hideOverrideModal = () => {
            overrideModal.classList.remove('show');
        };

        window.onclick = (event) => {
            if (event.target == analysisModal) hideModal();
            if (event.target == overrideModal) hideOverrideModal(); 
        };

        const getChangeHtml = (change) => {
            const num = parseInt(String(change).replace(/,/g, ''), 10);
            if (num > 0) return `<span class="flex items-center text-green-400"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>${num.toLocaleString()}</span>`;
            if (num < 0) return `<span class="flex items-center text-red-400"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>${Math.abs(num).toLocaleString()}</span>`;
            return `<span class="text-gray-500">${num}</span>`;
        };

        const getStatusHtml = (status, twitchLink) => {
            const s = String(status).toLowerCase();
            if (s.includes('live')) return `<a href="${twitchLink}" target="_blank" class="animate-live-pulse bg-red-600 text-white text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">LIVE</a>`;
            if (s.includes('match')) return `<span class="bg-purple-600 text-white text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">IN-MATCH</span>`;
            let html = `<span class="text-gray-400">${status || 'Offline'}</span>`;
            if (twitchLink) html += `<a href="${twitchLink}" target="_blank" class="inline-block ml-2 text-gray-500 hover:text-purple-400 transition-colors" title="Visit Twitch channel"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M11.571 4.714h1.715v5.143H11.57zm4.714 0h1.715v5.143h-1.715zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0H6zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714v9.429z"/></svg></a>`;
            return `<div class="flex items-center">${html}</div>`;
        };
        
        const getStreamHtml = (stream) => {
            if (stream && stream.viewers) return `<div class="flex flex-col"><span class="font-semibold text-white">${stream.viewers.toLocaleString()} viewers</span><span class="text-xs text-gray-400">${stream.game || 'Streaming'}</span></div>`;
            return `<span class="text-gray-600">-</span>`;
        };
        
        const renderLeaderboard = (playersToRender) => { 
            leaderboardBody.innerHTML = ''; 
            if (!Array.isArray(playersToRender) || playersToRender.length === 0) {
                leaderboardBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No players found.</td></tr>`; 
                return;
            }
            playersToRender.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700/50 hover:bg-gray-700/30 transition-colors duration-200';
                
                // Safe access with fallbacks for undefined values
                const safePlayer = {
                    rank: player.rank || 0,
                    name: player.name || 'Unknown Player',
                    rp: player.rp || 0,
                    change: player.change || 0,
                    level: player.level || 0,
                    status: player.status || 'Unknown',
                    twitchLink: player.twitchLink || null,
                    stream: player.stream || null
                };
                
                const playerNameHtml = safePlayer.twitchLink ? `<a href="${safePlayer.twitchLink}" target="_blank" class="hover:text-emerald-400 transition-colors">${safePlayer.name}</a>` : safePlayer.name;
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-200">#${safePlayer.rank}</td>
                    <td class="px-6 py-4 font-bold text-white">${playerNameHtml}</td>
                    <td class="px-6 py-4 font-semibold text-emerald-400">${safePlayer.rp.toLocaleString()}</td>
                    <td class="px-6 py-4">${getChangeHtml(safePlayer.change)}</td>
                    <td class="px-6 py-4">${safePlayer.level.toLocaleString()}</td>
                    <td class="px-6 py-4">${getStatusHtml(safePlayer.status, safePlayer.twitchLink)}</td>
                    <td class="px-6 py-4">${getStreamHtml(safePlayer.stream)}</td>
                    <td class="px-6 py-4"><button onclick="analyzePlayerPerformance('${safePlayer.name}', ${safePlayer.rp}, ${safePlayer.change}, ${safePlayer.level})" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-full text-xs transition-colors duration-200">Analyze ✨</button></td>
                `;
                row.addEventListener('mouseenter', (event) => handleMouseEnter(event, safePlayer));
                row.addEventListener('mouseleave', handleMouseLeave);
                row.addEventListener('mousemove', handleMouseMove);
                leaderboardBody.appendChild(row);
            });
        };

        const handleMouseEnter = (event, player) => {
            clearTimeout(previewTimeout);
            if (player.status === 'Live' && player.stream && player.stream.twitchUser) {
                previewTimeout = setTimeout(() => showStreamPreview(player.stream.twitchUser), 300); 
            }
        };

        const handleMouseLeave = () => { 
            clearTimeout(previewTimeout); 
            hideStreamPreview(); 
        };

        const handleMouseMove = (event) => {
            const offsetX = 20, offsetY = 20;
            let top = event.clientY + offsetY, left = event.clientX + offsetX;
            if (top + streamPreview.offsetHeight > window.innerHeight) top = event.clientY - streamPreview.offsetHeight - offsetY;
            if (left + streamPreview.offsetWidth > window.innerWidth) left = event.clientX - streamPreview.offsetWidth - offsetX;
            streamPreview.style.top = `${top}px`;
            streamPreview.style.left = `${left}px`;
        };

        const showStreamPreview = (twitchUser) => {
            streamPreviewPlayer.innerHTML = ''; 
            new Twitch.Embed(streamPreviewPlayer, {
                width: "100%", height: "100%", channel: twitchUser,
                layout: "video", muted: true, autoplay: true, parent: ["localhost", window.location.hostname] 
            });
            streamPreview.style.opacity = '1';
            streamPreview.style.transform = 'scale(1)';
        };

        const hideStreamPreview = () => {
            streamPreview.style.opacity = '0';
            streamPreview.style.transform = 'scale(0.95)';
            setTimeout(() => { streamPreviewPlayer.innerHTML = ''; }, 200);
        };

        const applyFilters = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const liveOnly = liveOnlyToggle.checked;
            
            filteredAndSortedPlayers = allPlayers;

            if (liveOnly) filteredAndSortedPlayers = filteredAndSortedPlayers.filter(p => String(p.status).toLowerCase() === 'live');
            if (searchTerm) filteredAndSortedPlayers = filteredAndSortedPlayers.filter(p => String(p.name).toLowerCase().includes(searchTerm));
            
            currentPage = 1; 
            updateLeaderboardAndPagination();
        };

        function renderPredatorThresholds(data) {
            predatorThresholdsDiv.innerHTML = '';
            const platformOrder = { PC: 'PC', PS4: 'PlayStation', X1: 'Xbox', SWITCH: 'Switch' };
            const platformColors = {
                PC: 'border-blue-700/50', PS4: 'border-blue-700/50',
                X1: 'border-green-700/50', SWITCH: 'border-red-700/50'
            };

            for (const key in platformOrder) {
                const platformData = data && data[key];
                const card = document.createElement('div');
                card.className = `p-5 rounded-xl shadow-2xl shadow-black/30 border ${platformColors[key] || 'border-gray-700/50'} bg-gray-800/50 backdrop-blur-sm`;
                
                // Check if platform data exists and has valid structure (not just error)
                if (platformData && !platformData.error && platformData.predator_rp !== undefined && platformData.masters_count !== undefined) {
                    let mastersCount = platformData.masters_count || 0;
                    let predsCount = Math.min(mastersCount, 750);
                    let mastersDisplay = Math.max(0, mastersCount - predsCount).toLocaleString();
                    let mastersPredsDisplay = `${predsCount.toLocaleString()} Preds & ${mastersDisplay} Masters`;

                    card.innerHTML = `
                        <h3 class="font-semibold text-gray-300">${platformOrder[key]}</h3>
                        <p class="text-3xl font-bold text-white my-1">${(platformData.predator_rp || 0).toLocaleString()} RP</p>
                        <p class="text-xs text-gray-400">Predator Threshold</p>
                        <div class="text-sm mt-2 font-medium">${getChangeHtml(platformData.rp_change_24h || 0)} in 24h</div>
                        <p class="text-sm text-gray-400 mt-1">${mastersPredsDisplay}</p>
                    `;
                } else {
                    // Show error message or fallback
                    let errorMessage = "Data not available";
                    if (platformData && platformData.error) {
                        errorMessage = "Service temporarily unavailable";
                    }
                    card.innerHTML = `
                        <h3 class="font-semibold text-gray-300">${platformOrder[key]}</h3>
                        <p class="text-sm mt-2 text-red-400">${errorMessage}</p>
                        <p class="text-xs text-gray-500 mt-1">Please try again later</p>
                    `;
                }
                predatorThresholdsDiv.appendChild(card);
            }
        }

        function renderRpDistributionChart(players) {
            const ctx = document.getElementById('rpDistributionChart').getContext('2d');
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available, displaying text fallback');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Chart.js library not loaded', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Safety check for players array
            if (!Array.isArray(players) || players.length === 0) {
                if (rpChart) rpChart.destroy();
                // Display a message instead of an empty chart
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No player data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const topPlayers = players.slice(0, 20);
            
            if (rpChart) rpChart.destroy();

            rpChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topPlayers.map(p => p.name || 'Unknown'),
                    datasets: [{
                        label: 'Player RP',
                        data: topPlayers.map(p => p.rp || 0),
                        backgroundColor: 'rgba(52, 211, 153, 0.6)', 
                        borderColor: 'rgba(5, 150, 105, 1)', 
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: false,
                            ticks: { color: '#e5e7eb' }, 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                        },
                        x: { 
                            ticks: { 
                                color: '#e5e7eb', 
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 16 ? label.substring(0, 16) + '...' : label;
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                        }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toLocaleString() + ' RP';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderPlatformDistributionChart(data) {
            const ctx = document.getElementById('platformDistributionChart').getContext('2d');
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available, displaying text fallback');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Chart.js library not loaded', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Safety check for data
            if (!data || typeof data !== 'object') {
                if (platformChart) platformChart.destroy();
                // Display a message instead of an empty chart
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No platform data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const platformData = Object.values(data).filter(p => p && p.masters_count && !p.error);
            
            if (platformChart) platformChart.destroy();

            // Use safe access with fallbacks
            const chartData = [
                (data.PC && !data.PC.error) ? (data.PC.masters_count || 0) : 0,
                (data.PS4 && !data.PS4.error) ? (data.PS4.masters_count || 0) : 0,
                (data.X1 && !data.X1.error) ? (data.X1.masters_count || 0) : 0,
                (data.SWITCH && !data.SWITCH.error) ? (data.SWITCH.masters_count || 0) : 0
            ];

            // Check if we have any valid data
            const hasValidData = chartData.some(count => count > 0);
            
            if (!hasValidData) {
                // Display a message instead of an empty chart
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Platform data temporarily unavailable', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            platformChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['PC', 'PlayStation', 'Xbox', 'Switch'],
                    datasets: [{
                        label: 'Masters & Predators',
                        data: chartData,
                        backgroundColor: ['#3b82f6', '#2563eb', '#1e813a', '#ef4444'], 
                        hoverOffset: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { color: '#e5e7eb' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += context.parsed.toLocaleString() + ' Masters/Preds';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function analyzePlayerPerformance(playerName, playerRp, rpChange24h, playerLevel) {
            showModal(`Analyzing ${playerName}'s Performance`, '<div class="spinner"></div><p class="text-center mt-2">Generating analysis...</p>');
            const prompt = `As an Apex Legends coach, provide **3-4 concise, actionable bullet points** of feedback for player ${playerName}. Their current RP is ${playerRp}, 24-hour RP change: ${rpChange24h}, Level: ${playerLevel}. Focus on clear strengths and 1-2 key areas for improvement. Use a direct, encouraging tone. Very brief, max 70 words.`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);
                
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    modalContent.innerHTML = `<p class="text-gray-300">${result.candidates[0].content.parts[0].text}</p>`;
                } else {
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-500">Error generating analysis: ${error.message}</p>`;
                console.error("Error calling Gemini API:", error);
            }
        }

        async function getLegendTips(legendName) {
            showModal(`Insights for ${legendName} ✨`, '<div class="spinner"></div><p class="text-center mt-2">Fetching legend insights...</p>');
            const prompt = `Give me a **very brief lore bite** for ${legendName} from Apex Legends, then **3-4 super concise tactical tips** (bullet points) on using their abilities effectively. Max 60 words. Think quick, actionable advice.`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);
                
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    modalContent.innerHTML = `<p class="text-gray-300">${result.candidates[0].content.parts[0].text}</p>`;
                } else {
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-500">Error fetching legend insights: ${error.message}</p>`;
                console.error("Error calling Gemini API for legend tips:", error);
            }
        }


        async function submitTwitchOverride(event) {
            event.preventDefault(); 
            overrideMessageDiv.textContent = 'Submitting...';
            overrideMessageDiv.className = 'text-sm font-medium text-gray-400';

            const playerName = overridePlayerNameInput.value.trim();
            const twitchUsername = overrideTwitchUsernameInput.value.trim();

            if (!playerName || !twitchUsername) {
                overrideMessageDiv.textContent = 'Player Name and Twitch Username are required.';
                overrideMessageDiv.className = 'text-sm font-medium text-red-500';
                return;
            }

            const overrideApiUrl = `${API_BASE_URL}/api/add-twitch-override`;
            try {
                const response = await fetch(overrideApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ player_name: playerName, twitch_username: twitchUsername })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    overrideMessageDiv.textContent = `Override for ${playerName} added/updated successfully!`;
                    overrideMessageDiv.className = 'text-sm font-medium text-green-500';
                    setTimeout(() => {
                        hideOverrideModal();
                        initializeApp(); 
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to submit override.');
                }
            } catch (error) {
                overrideMessageDiv.textContent = `Error: ${error.message}`;
                overrideMessageDiv.className = 'text-sm font-medium text-red-500';
                console.error('Error submitting Twitch override:', error);
            }
        }

        // Function to handle API source change (Tracker.gg vs MozambiqueHe.re)
        const handleApiSourceChange = () => {
            const selectedApi = document.querySelector('input[name="apiSource"]:checked').value;
            const switchOption = platformSelect.querySelector('option[value="switch"]');
            
            if (selectedApi === 'mozambique') {
                useUidCheckbox.disabled = false;
                if (!switchOption) {
                    const newSwitchOption = document.createElement('option');
                    newSwitchOption.value = 'switch';
                    newSwitchOption.setAttribute('data-mozambique-platform', 'SWITCH');
                    newSwitchOption.textContent = 'Nintendo Switch (Mozambique only)';
                    platformSelect.appendChild(newSwitchOption);
                }
            } else { // Tracker.gg selected
                useUidCheckbox.disabled = true;
                useUidCheckbox.checked = false;
                if (platformSelect.value === 'switch') {
                    platformSelect.value = 'origin'; // Default back to PC if Switch was selected
                }
                if (switchOption) {
                    platformSelect.removeChild(switchOption);
                }
            }
        };


        async function fetchPlayerStats(event) {
            event.preventDefault();
            playerStatsMessageDiv.textContent = '';
            playerStatsContentDiv.innerHTML = '<div class="spinner"></div><p class="text-center mt-2">Fetching player data...</p>';
            matchHistoryContentDiv.innerHTML = '<div class="spinner"></div><p class="text-center mt-2">Fetching match history...</p>';
            matchHistoryResultDiv.style.display = 'none'; 

            const identifier = playerIdentifierInput.value.trim();
            const selectedApi = document.querySelector('input[name="apiSource"]:checked').value;
            let platformValue = platformSelect.value; 

            if (!identifier) {
                playerStatsMessageDiv.textContent = 'Player Name or UID is required.';
                playerStatsMessageDiv.className = 'text-sm font-medium text-red-500';
                playerStatsContentDiv.innerHTML = '<p>Enter player details and click "Get Player Stats" to see results.</p>';
                return;
            }

            try {
                let profileResponse, sessionsResponse;

                if (selectedApi === 'tracker') {
                    const trackerProfileUrl = `${API_BASE_URL}/api/tracker-stats?platform=${platformValue}&identifier=${encodeURIComponent(identifier)}&type=profile`;
                    const trackerSessionsUrl = `${API_BASE_URL}/api/tracker-stats?platform=${platformValue}&identifier=${encodeURIComponent(identifier)}&type=sessions`;
                    
                    [profileResponse, sessionsResponse] = await Promise.all([
                        fetch(trackerProfileUrl),
                        fetch(trackerSessionsUrl)
                    ]);

                    if (!profileResponse.ok) {
                        const errorData = await profileResponse.json();
                        throw new Error(errorData.message || `Tracker.gg Profile API error: ${profileResponse.status}`);
                    }
                    const profileData = await profileResponse.json();
                    renderPlayerStatsTrackerGG(profileData);

                    if (sessionsResponse.ok) {
                        const sessionsData = await sessionsResponse.json();
                        renderMatchHistoryTrackerGG(sessionsData);
                    } else {
                        const errorData = await sessionsResponse.json();
                        matchHistoryContentDiv.innerHTML = `<p class="text-gray-500">Could not load match history: ${errorData.message || sessionsResponse.statusText}.</p>`;
                        matchHistoryResultDiv.style.display = 'block'; 
                        console.warn('Tracker.gg Sessions API error:', errorData.message || sessionsResponse.statusText);
                    }

                } else { // MozambiqueHe.re selected
                    const mozambiquePlatform = platformSelect.options[platformSelect.selectedIndex].getAttribute('data-mozambique-platform');
                    let mozambiqueApiUrl = `https://api.mozambiquehe.re/bridge?auth=${MOZAMBIQUE_API_KEY}&platform=${mozambiquePlatform}`;
                    
                    if (useUidCheckbox.checked) {
                        mozambiqueApiUrl += `&uid=${identifier}`;
                    } else {
                        mozambiqueApiUrl += `&player=${identifier}`;
                    }

                    profileResponse = await fetch(mozambiqueApiUrl);

                    if (!profileResponse.ok) {
                        const errorData = await profileResponse.json();
                        throw new Error(errorData.Error || `MozambiqueHe.re API error: ${profileResponse.status}`);
                    }
                    const profileData = await profileResponse.json();
                    renderPlayerStatsMozambique(profileData);
                }

            } catch (error) {
                playerStatsMessageDiv.textContent = `Error: ${error.message}`;
                playerStatsMessageDiv.className = 'text-sm font-medium text-red-500';
                playerStatsContentDiv.innerHTML = `<p class="text-red-500">Failed to load player stats. ${error.message}</p>`;
                matchHistoryContentDiv.innerHTML = `<p class="text-red-500">Failed to load match history. ${error.message}</p>`;
                matchHistoryResultDiv.style.display = 'block'; 
                console.error('Error fetching player stats:', error);
            }
        }

        function renderPlayerStatsTrackerGG(data) {
            playerStatsMessageDiv.textContent = ''; 
            if (!data.success && data.message) {
                playerStatsContentDiv.innerHTML = `<p class="text-red-500">Error: ${data.message}</p>`;
                return;
            }
            if (!data.data) {
                playerStatsContentDiv.innerHTML = `<p class="text-red-500">Error: Player not found or data is unavailable from Tracker.gg.</p>`;
                return;
            }

            const player = data.data;
            const segments = player.segments;
            const overview = segments.find(s => s.type === 'overview');
            const lifetimeStats = overview?.stats;
            const rankSegment = segments.find(s => s.type === 'playlist' && s.attributes.playlistId === 'ranked');
            const currentRank = rankSegment?.stats?.rankScore;
            const selectedLegendSegment = segments.find(s => s.type === 'legend' && s.metadata.isActive);
            const legendImageUrl = selectedLegendSegment?.metadata?.imageUrl || '';

            let statsHtml = `
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Left Column: Player Info & Rank -->
                    <div class="flex-none lg:w-1/3 space-y-6">
                        <div class="stat-card text-center">
                            <img src="${player.platformInfo?.avatarUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/e5e7eb?text=?';" alt="Avatar" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-emerald-500">
                            <h4 class="text-2xl font-bold text-white">${player.platformInfo?.platformUserHandle || 'N/A'}</h4>
                            <p class="text-gray-400">${player.platformInfo?.platformSlug?.toUpperCase() || 'N/A'}</p>
                        </div>
                        <div class="stat-card">
                            <h5 class="text-gray-400 text-sm mb-2">Current Rank</h5>
                            <div class="flex items-center gap-4">
                                <img src="${currentRank?.metadata?.iconUrl || ''}" alt="${currentRank?.metadata?.rankName || ''}" class="h-16 w-16">
                                <div>
                                    <p class="text-xl font-bold text-white">${currentRank?.metadata?.rankName || 'N/A'}</p>
                                    <p class="text-emerald-400">${currentRank?.value?.toLocaleString() || 'N/A'} RP</p>
                                </div>
                            </div>
                        </div>
                         <div class="stat-card">
                            <h5 class="text-gray-400 text-sm mb-1">Level</h5>
                            <p class="text-3xl font-bold text-white">${lifetimeStats?.level?.displayValue || 'N/A'}</p>
                        </div>
                    </div>

                    <!-- Right Column: Legend & Lifetime Stats -->
                    <div class="flex-grow space-y-6">
                        <div class="stat-card legend-card" style="background-image: url('${legendImageUrl}')">
                            <h5 class="text-gray-300 text-sm mb-2">Selected Legend</h5>
                            <p class="text-3xl font-bold text-white mb-4">${selectedLegendSegment?.metadata?.name || 'N/A'}</p>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                                ${selectedLegendSegment?.stats ? Object.values(selectedLegendSegment.stats).map(stat => `
                                    <div>
                                        <span class="text-gray-400">${stat.displayName}: </span>
                                        <span class="font-semibold text-white">${stat.displayValue}</span>
                                    </div>
                                `).join('') : '<p>No stats for this legend.</p>'}
                            </div>
                            ${selectedLegendSegment?.metadata?.name !== 'N/A' ? `<button onclick="getLegendTips('${selectedLegendSegment.metadata.name}')" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-full text-xs transition-colors duration-200">Get Legend Tips ✨</button>` : ''}
                        </div>
                        <div class="stat-card">
                            <h5 class="text-gray-400 text-sm mb-2">Lifetime Stats</h5>
                             <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 text-sm">
                                ${lifetimeStats ? Object.values(lifetimeStats).map(stat => {
                                    if (!stat.displayValue || stat.displayValue === 'N/A' || ['level', 'rankScore'].includes(stat.metadata.key)) return '';
                                    return `<div>
                                        <span class="text-gray-400">${stat.displayName}: </span>
                                        <span class="font-semibold text-white">${stat.displayValue}</span>
                                    </div>`;
                                }).join('') : '<p>No lifetime stats.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            playerStatsContentDiv.innerHTML = statsHtml;
        }

        function renderPlayerStatsMozambique(data) {
            playerStatsMessageDiv.textContent = '';
            matchHistoryResultDiv.style.display = 'none';

            if (data.Error) {
                playerStatsContentDiv.innerHTML = `<p class="text-red-500">Error: ${data.Error}</p>`;
                return;
            }
            if (!data.global) {
                playerStatsContentDiv.innerHTML = `<p class="text-red-500">Error: Player not found or data is unavailable from MozambiqueHe.re.</p>`;
                return;
            }

            const global = data.global;
            const legend = data.legends.selected;
            const legendImageUrl = legend?.ImgAssets?.banner || '';

            let statsHtml = `
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Left Column: Player Info & Rank -->
                    <div class="flex-none lg:w-1/3 space-y-6">
                        <div class="stat-card text-center">
                            <img src="${global.avatar}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/e5e7eb?text=?';" alt="Avatar" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-emerald-500">
                            <h4 class="text-2xl font-bold text-white">${global.name || 'N/A'}</h4>
                            <p class="text-gray-400">${global.platform || 'N/A'}</p>
                        </div>
                        <div class="stat-card">
                            <h5 class="text-gray-400 text-sm mb-2">Current Rank</h5>
                            <div class="flex items-center gap-4">
                                <img src="${global.rank?.rankImg || ''}" alt="${global.rank?.rankName || ''}" class="h-16 w-16">
                                <div>
                                    <p class="text-xl font-bold text-white">${global.rank?.rankName || 'N/A'} ${global.rank?.rankDiv || ''}</p>
                                    <p class="text-emerald-400">${global.rank?.rankScore?.toLocaleString() || 'N/A'} RP</p>
                                </div>
                            </div>
                        </div>
                         <div class="stat-card">
                            <h5 class="text-gray-400 text-sm mb-1">Level</h5>
                            <p class="text-3xl font-bold text-white">${global.level || 'N/A'}</p>
                        </div>
                    </div>

                    <!-- Right Column: Legend & Recent Matches -->
                    <div class="flex-grow space-y-6">
                        <div class="stat-card legend-card" style="background-image: url('${legendImageUrl}')">
                            <h5 class="text-gray-300 text-sm mb-2">Selected Legend</h5>
                            <p class="text-3xl font-bold text-white mb-4">${legend?.LegendName || 'N/A'}</p>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                                ${legend?.data ? legend.data.map(stat => `
                                    <div>
                                        <span class="text-gray-400">${stat.name}: </span>
                                        <span class="font-semibold text-white">${stat.value?.toLocaleString() || '0'}</span>
                                    </div>
                                `).join('') : '<p>No stats for this legend.</p>'}
                            </div>
                             ${legend?.LegendName ? `<button onclick="getLegendTips('${legend.LegendName}')" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-full text-xs transition-colors duration-200">Get Legend Tips ✨</button>` : ''}
                        </div>
                        <div class="stat-card">
                            <h5 class="text-gray-400 text-sm mb-2">Recent Matches</h5>
                            <div class="space-y-2">
                                 ${data.history?.length > 0 ? 
                                    data.history.slice(0, 5).map(match => `
                                        <div class="text-sm">
                                            <span class="font-semibold text-white">${match.gameMode || 'N/A'}</span> - Kills: <span class="text-emerald-400">${match.kills?.toLocaleString() || '0'}</span>, Damage: <span class="text-emerald-400">${match.damage?.toLocaleString() || '0'}</span> <span class="text-gray-500 text-xs">(${new Date(match.timestamp * 1000).toLocaleDateString()})</span>
                                        </div>
                                    `).join('')
                                 : '<p class="text-gray-500">No recent match history available.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            playerStatsContentDiv.innerHTML = statsHtml;
        }

        function renderMatchHistoryTrackerGG(data) {
            matchHistoryResultDiv.style.display = 'block';
            matchHistoryContentDiv.innerHTML = '';

            if (!data.success && data.message) {
                matchHistoryContentDiv.innerHTML = `<p class="text-red-500">Error: ${data.message}</p>`;
                return;
            }
            if (!data || !data.data || data.data.length === 0) {
                matchHistoryContentDiv.innerHTML = '<p class="text-gray-500">No recent match history available for this player.</p>';
                return;
            }

            let historyHtml = '<div class="space-y-4">';
            data.data.forEach(session => {
                historyHtml += `
                    <div class="stat-card">
                        <h5 class="text-lg font-bold text-white mb-2">${session.metadata.name || 'Game Session'}</h5>
                        <p class="text-sm text-gray-400 mb-3">${new Date(session.metadata.startDate).toLocaleString()}</p>
                        <div class="space-y-3">
                `;
                if (session.matches && session.matches.length > 0) {
                    session.matches.forEach(match => {
                        const matchStats = match.stats;
                        const kills = matchStats?.kills?.displayValue || '0';
                        const damage = matchStats?.damage?.displayValue || '0';
                        const gameMode = match.metadata?.playlistName || 'N/A';
                        const legendPlayed = match.metadata?.legendName || 'N/A';
                        historyHtml += `
                            <div class="match-card">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-semibold text-white">${legendPlayed}</span>
                                        <span class="text-gray-400"> in ${gameMode}</span>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm">Kills: <span class="font-bold text-emerald-400">${kills}</span></p>
                                        <p class="text-sm">Damage: <span class="font-bold text-emerald-400">${damage}</span></p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    historyHtml += `<p class="text-gray-500">No detailed matches for this session.</p>`;
                }
                historyHtml += '</div></div>';
            });
            historyHtml += '</div>';
            matchHistoryContentDiv.innerHTML = historyHtml;
        }


        const updatePaginationControls = () => {
            const totalPages = Math.ceil(filteredAndSortedPlayers.length / itemsPerPage);
            pageNumbersDiv.innerHTML = ''; 

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 rounded-lg ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-700 hover:bg-gray-600'} transition-colors duration-200`;
                pageButton.onclick = () => {
                    currentPage = i;
                    updateLeaderboardAndPagination();
                };
                pageNumbersDiv.appendChild(pageButton);
            }

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        };

        const updateLeaderboardAndPagination = () => {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const playersToRender = filteredAndSortedPlayers.slice(startIndex, endIndex);
            
            renderLeaderboard(playersToRender);
            updatePaginationControls();
        };

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateLeaderboardAndPagination();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredAndSortedPlayers.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateLeaderboardAndPagination();
            }
        });


        async function initializeApp() {
            // API URLs - using global API_BASE_URL
            const leaderboardUrl = `${API_BASE_URL}/api/leaderboard/PC`; 
            const predatorThresholdsUrl = `${API_BASE_URL}/api/predator-points`; 

            try {
                const [leaderboardResponse, predatorResponse] = await Promise.all([
                    fetch(leaderboardUrl),
                    fetch(predatorThresholdsUrl)
                ]);

                // Handle leaderboard data
                let leaderboardData = null;
                if (leaderboardResponse.ok) {
                    const leaderboardResult = await leaderboardResponse.json();
                    if (leaderboardResult.success && leaderboardResult.data?.players) {
                        leaderboardData = leaderboardResult.data;
                    }
                }

                // Handle predator thresholds data
                let predatorData = null;
                if (predatorResponse.ok) {
                    const predatorResult = await predatorResponse.json();
                    if (predatorResult.success && predatorResult.data) {
                        predatorData = predatorResult.data;
                    }
                }

                // Process leaderboard data or use fallback
                if (leaderboardData && leaderboardData.players) {
                    allPlayers = leaderboardData.players.map(player => {
                        const isLive = player.twitch_live?.is_live;
                        const streamData = isLive ? player.twitch_live.stream_data : null;
                        let displayName = player.player_name || 'Unknown Player';
                        const isGenericName = (displayName.toLowerCase().startsWith('player') && !isNaN(displayName.substring(6))) || displayName.toLowerCase() === 'empty name';
                        
                        if (isGenericName) {
                            if (isLive && streamData?.user_name) {
                                displayName = streamData.user_name;
                            } else if (player.twitch_link) {
                                try {
                                    const pathSegments = new URL(player.twitch_link).pathname.split('/').filter(Boolean);
                                    if (pathSegments.length > 0) displayName = pathSegments.pop();
                                } catch (e) { /* ignore parsing errors */ }
                            }
                        }

                        return {
                            rank: player.rank || 0,
                            name: displayName, 
                            rp: player.rp || 0, 
                            change: player.rp_change_24h || 0,
                            level: player.level || 0, 
                            status: isLive ? 'Live' : (player.status || 'Unknown'), 
                            twitchLink: player.twitch_link || null,
                            stream: streamData ? { viewers: streamData.viewer_count || 0, game: streamData.game_name || 'Streaming', twitchUser: streamData.user_name || displayName } : null
                        };
                    });
                } else {
                    // Provide fallback data when API fails
                    allPlayers = [];
                    console.warn('Using fallback: No leaderboard data available from API');
                }
                
                filteredAndSortedPlayers = [...allPlayers]; 
                currentPage = 1; 
                updateLeaderboardAndPagination(); 

                // Render components with safe data
                renderPredatorThresholds(predatorData);
                renderRpDistributionChart(allPlayers);
                renderPlatformDistributionChart(predatorData);
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                
                // Show user-friendly error messages
                leaderboardBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-red-500">
                    <div class="flex flex-col items-center space-y-2">
                        <span>Failed to load leaderboard data</span>
                        <span class="text-sm text-gray-400">Please check your connection and try refreshing the page</span>
                    </div>
                </td></tr>`; 
                
                predatorThresholdsDiv.innerHTML = `
                    <div class="col-span-4 text-center">
                        <p class="text-red-500 mb-2">Could not load predator thresholds</p>
                        <p class="text-sm text-gray-400">API services may be temporarily unavailable</p>
                    </div>
                `;

                // Initialize empty charts to prevent further errors
                renderRpDistributionChart([]);
                renderPlatformDistributionChart(null);
            }
        }

        searchInput.addEventListener('input', applyFilters);
        liveOnlyToggle.addEventListener('change', applyFilters);
        overrideForm.addEventListener('submit', submitTwitchOverride); 
        playerStatsForm.addEventListener('submit', fetchPlayerStats); 
        window.onload = initializeApp;

        // Initialize API source selection
        handleApiSourceChange(); // Call on load to set initial state
    </script>
</body>
</html>
